generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(uuid())
  email               String         @unique
  password            String
  name                String
  role                UserRole       @default(ORG_USER)
  isActive            Boolean        @default(true)
  organizationId      String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  lastLogin           DateTime?
  auditLogs           AuditLog[]
  notifications       Notification[]
  reviewedSubmissions Submission[]   @relation("ReviewedBy")
  submissions         Submission[]   @relation("SubmittedBy")
  organization        Organization?  @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

model Organization {
  id                   String       @id @default(uuid())
  name                 String
  code                 String       @unique
  type                 OrgType
  sector               String?
  registrationNo       String?
  contactEmail         String
  contactPhone         String?
  address              String?
  isActive             Boolean      @default(true)
  complianceScore      Int          @default(0)
  completedSubmissions Int          @default(0)
  pendingSubmissions   Int          @default(0)
  overdueSubmissions   Int          @default(0)
  lastSubmissionDate   DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  submissions          Submission[]
  users                User[]

  @@index([code])
  @@index([type])
  @@map("organizations")
}

model Submission {
  id               String           @id @default(uuid())
  organizationId   String
  month            Int
  year             Int
  status           SubmissionStatus @default(DRAFT)
  indicators       Json
  totalIndicators  Int
  filledIndicators Int
  completionRate   Int              @default(0)
  submittedBy      String?
  submittedAt      DateTime?
  reviewedBy       String?
  reviewedAt       DateTime?
  reviewNotes      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reviewer         User?            @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  submitter        User?            @relation("SubmittedBy", fields: [submittedBy], references: [id])

  @@unique([organizationId, month, year])
  @@index([organizationId])
  @@index([status])
  @@index([year, month])
  @@map("submissions")
}

model Conversation {
  id            String           @id @default(uuid())
  type          ConversationType
  participants  Json
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  lastMessageAt DateTime         @default(now())
  messages      Message[]

  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  senderName     String
  senderType     SenderType
  senderOrgCode  String?
  content        String
  messageType    MessageType  @default(TEXT)
  readBy         Json         @default("[]")
  createdAt      DateTime     @default(now())
  attachments    Attachment[]
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

model Attachment {
  id         String   @id @default(uuid())
  messageId  String
  fileName   String
  fileType   FileType
  fileUrl    String
  fileSize   Int
  uploadedAt DateTime @default(now())
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("attachments")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  priority  Priority         @default(MEDIUM)
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  FIA_ADMIN
  ORG_ADMIN
  ORG_USER
}

enum OrgType {
  REGULATOR           // BOU, CMA, IRA, UMRA, URSB, NLGRB, NGO_BUREAU
  MINISTRY            // MEMD
  PROFESSIONAL        // ICPAU, ULC
  FIA                 // FIA itself
  LAW_ENFORCEMENT     // CID, IG, UWA, URA
  PROSECUTION         // ODPP
  INTERNATIONAL       // INTERPOL
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ConversationType {
  ADMIN_TO_ORG
  ORG_TO_ORG
}

enum SenderType {
  ADMIN
  ORGANIZATION
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  AUDIO
}

enum FileType {
  IMAGE
  PDF
  DOCUMENT
  EXCEL
  AUDIO
  VIDEO
}

enum NotificationType {
  SUBMISSION_DUE
  SUBMISSION_OVERDUE
  SUBMISSION_APPROVED
  SUBMISSION_REJECTED
  NEW_MESSAGE
  SYSTEM_ALERT
  COMPLIANCE_WARNING
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}